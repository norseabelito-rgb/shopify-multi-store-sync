name: Customers incremental sync

on:
  schedule:
    - cron: "*/15 * * * *" # every 15 minutes (UTC)
  workflow_dispatch: {}

# Prevent concurrent runs - only one sync at a time
concurrency:
  group: customers-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Trigger incremental customers sync
        run: |
          # Retry logic for network issues and Railway cold starts
          MAX_RETRIES=3
          RETRY_DELAY=5

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."

            HTTP_CODE=$(curl --write-out '%{http_code}' --silent --output /tmp/response.json \
              --max-time 30 \
              -X POST "${{ secrets.CUSTOMERS_SYNC_URL }}" \
              -H "x-tasks-secret: ${{ secrets.TASKS_SECRET }}" \
              -H "content-type: application/json" \
              --data '{}')

            echo "HTTP Status: $HTTP_CODE"
            cat /tmp/response.json
            echo ""

            # 202 Accepted = success (job started in background)
            if [ "$HTTP_CODE" -eq 202 ]; then
              echo "✓ Customers sync job started successfully"
              exit 0
            fi

            # 502/503/504 = Railway cold start or temporary issue, retry
            if [ "$HTTP_CODE" -eq 502 ] || [ "$HTTP_CODE" -eq 503 ] || [ "$HTTP_CODE" -eq 504 ]; then
              echo "⚠ Server unavailable (HTTP $HTTP_CODE), retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              continue
            fi

            # Other errors = fail immediately
            echo "✗ Request failed with HTTP $HTTP_CODE"
            exit 1
          done

          echo "✗ Failed after $MAX_RETRIES attempts"
          exit 1
